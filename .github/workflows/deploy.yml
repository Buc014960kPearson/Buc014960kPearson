name: Phased Concurrent Jobs Workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Persist Runner ID
        run: echo "RUNNER_ID=${{ runner.name }}" >> $GITHUB_ENV

  phase1:
    needs: setup
    runs-on: ${{ needs.setup.outputs.runner_id }}
    strategy:
      matrix:
        job: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    steps:
      - name: Phase 1 - Job ${{ matrix.job }}
        run: |
          echo "Running Phase 1 for Job ${{ matrix.job }} on ${{ runner.name }}"
          sleep $((RANDOM % 10 + 5))  # Simulate work with random delay (5-14 seconds)
          echo "Phase 1 for Job ${{ matrix.job }} completed"
    outputs:
      runner_id: ${{ env.RUNNER_ID }}

  phase2:
    needs: phase1
    runs-on: ${{ needs.phase1.outputs.runner_id }}
    strategy:
      matrix:
        job: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    steps:
      - name: Phase 2 - Job ${{ matrix.job }}
        run: |
          echo "Running Phase 2 for Job ${{ matrix.job }} on ${{ runner.name }}"
          sleep $((RANDOM % 10 + 5))  # Simulate work with random delay (5-14 seconds)
          echo "Phase 2 for Job ${{ matrix.job }} completed"